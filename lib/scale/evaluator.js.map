{"version":3,"file":"evaluator.js","names":["log","getLogger","getNewEnd","fallbackEnd","xAccessor","initialXScale","start","lastItem","lastItemX","lastItemXValue","range","rangeStart","rangeEnd","newEnd","extentsWrapper","useWholeData","clamp","pointsPerPxThreshold","minPointsPerPxThreshold","flipXScale","filterData","data","inputDomain","currentPlotData","currentDomain","fallbackStart","plotData","domain","left","head","right","last","clampedDomain","filteredData","getFilteredResponse","length","isDefined","Math","max","min","realInputDomain","xScale","copy","width","floor","chartWidth","showMaxThreshold","canShowTheseManyPeriods","newXScale","newWidth","slice","showMax","arrayLength","maxThreshold","minThreshold","showMinThreshold","threshold","ceil","newLeftIndex","getClosestItemIndexes","newRightIndex","isNotDefined","invert"],"sources":["../../../src/lib/scale/evaluator.js"],"sourcesContent":["\r\n\r\nimport {\r\n\thead,\r\n\tlast,\r\n\tgetClosestItemIndexes,\r\n\tisDefined,\r\n\tisNotDefined,\r\n\tgetLogger,\r\n} from \"../utils\";\r\n\r\nconst log = getLogger(\"evaluator\");\r\n\r\nfunction getNewEnd(fallbackEnd, xAccessor, initialXScale, start) {\r\n\tconst {\r\n\t\tlastItem, lastItemX\r\n\t} = fallbackEnd;\r\n\tconst lastItemXValue = xAccessor(lastItem);\r\n\tconst [rangeStart, rangeEnd] = initialXScale.range();\r\n\r\n\tconst newEnd = (rangeEnd - rangeStart) / (lastItemX - rangeStart) * (lastItemXValue - start) + start;\r\n\treturn newEnd;\r\n}\r\n\r\nfunction extentsWrapper(useWholeData, clamp, pointsPerPxThreshold, minPointsPerPxThreshold, flipXScale) {\r\n\tfunction filterData(\r\n\t\tdata, inputDomain, xAccessor, initialXScale,\r\n\t\t{ currentPlotData, currentDomain, fallbackStart, fallbackEnd } = {}\r\n\t) {\r\n\t\tif (useWholeData) {\r\n\t\t\treturn { plotData: data, domain: inputDomain };\r\n\t\t}\r\n\r\n\t\tlet left = head(inputDomain);\r\n\t\tlet right = last(inputDomain);\r\n\t\tlet clampedDomain = inputDomain;\r\n\r\n\t\tlet filteredData = getFilteredResponse(data, left, right, xAccessor);\r\n\r\n\t\tif (filteredData.length === 1 && isDefined(fallbackStart)) {\r\n\t\t\tleft = fallbackStart;\r\n\t\t\tright = getNewEnd(fallbackEnd, xAccessor, initialXScale, left);\r\n\r\n\t\t\tclampedDomain = [\r\n\t\t\t\tleft,\r\n\t\t\t\tright,\r\n\t\t\t];\r\n\t\t\tfilteredData = getFilteredResponse(data, left, right, xAccessor);\r\n\t\t}\r\n\r\n\t\tif (typeof clamp === \"function\") {\r\n\t\t\tclampedDomain = clamp(clampedDomain, [xAccessor(head(data)), xAccessor(last(data))]);\r\n\t\t} else {\r\n\t\t\tif (clamp === \"left\" || clamp === \"both\" || clamp === true) {\r\n\t\t\t\tclampedDomain = [\r\n\t\t\t\t\tMath.max(left, xAccessor(head(data))),\r\n\t\t\t\t\tclampedDomain[1]\r\n\t\t\t\t];\r\n\t\t\t}\r\n\r\n\t\t\tif (clamp === \"right\" || clamp === \"both\" || clamp === true) {\r\n\t\t\t\tclampedDomain = [\r\n\t\t\t\t\tclampedDomain[0],\r\n\t\t\t\t\tMath.min(right, xAccessor(last(data)))\r\n\t\t\t\t];\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tif (clampedDomain !== inputDomain) {\r\n\t\t\tfilteredData = getFilteredResponse(data, clampedDomain[0], clampedDomain[1], xAccessor);\r\n\t\t}\r\n\r\n\t\tconst realInputDomain = clampedDomain;\r\n\t\t// [xAccessor(head(filteredData)), xAccessor(last(filteredData))];\r\n\r\n\t\tconst xScale = initialXScale.copy().domain(realInputDomain);\r\n\r\n\t\tlet width = Math.floor(xScale(xAccessor(last(filteredData)))\r\n\t\t\t- xScale(xAccessor(head(filteredData))));\r\n\r\n\t\t// prevent negative width when flipXScale\r\n\t\tif (flipXScale && width < 0) {\r\n\t\t\twidth = width * -1;\r\n\t\t}\r\n\r\n\t\tlet plotData, domain;\r\n\r\n\t\tconst chartWidth = last(xScale.range()) - head(xScale.range());\r\n\r\n\t\tlog(`Trying to show ${filteredData.length} points in ${width}px,`\r\n\t\t\t+ ` I can show up to ${showMaxThreshold(width, pointsPerPxThreshold) - 1} points in that width. `\r\n\t\t\t+ `Also FYI the entire chart width is ${chartWidth}px and pointsPerPxThreshold is ${pointsPerPxThreshold}`);\r\n\r\n\t\tif (canShowTheseManyPeriods(width, filteredData.length, pointsPerPxThreshold, minPointsPerPxThreshold)) {\r\n\t\t\tplotData = filteredData;\r\n\t\t\tdomain = realInputDomain;\r\n\t\t\tlog(\"AND IT WORKED\");\r\n\t\t} else {\r\n\t\t\tif (chartWidth > showMaxThreshold(width, pointsPerPxThreshold) && isDefined(fallbackEnd)) {\r\n\t\t\t\tplotData = filteredData;\r\n\t\t\t\tconst newEnd = getNewEnd(fallbackEnd, xAccessor, initialXScale, head(realInputDomain));\r\n\t\t\t\tdomain = [\r\n\t\t\t\t\thead(realInputDomain),\r\n\t\t\t\t\tnewEnd\r\n\t\t\t\t];\r\n\t\t\t\t// plotData = currentPlotData || filteredData.slice(filteredData.length - showMax(width, pointsPerPxThreshold));\r\n\t\t\t\t// domain = currentDomain || [xAccessor(head(plotData)), xAccessor(last(plotData))];\r\n\r\n\t\t\t\tconst newXScale = xScale.copy().domain(domain);\r\n\t\t\t\tconst newWidth = Math.floor(newXScale(xAccessor(last(plotData)))\r\n\t\t\t\t\t- newXScale(xAccessor(head(plotData))));\r\n\r\n\t\t\t\tlog(`and ouch, that is too much, so instead showing ${plotData.length} in ${newWidth}px`);\r\n\t\t\t} else {\r\n\t\t\t\tplotData = currentPlotData || filteredData.slice(filteredData.length - showMax(width, pointsPerPxThreshold));\r\n\t\t\t\tdomain = currentDomain || [xAccessor(head(plotData)), xAccessor(last(plotData))];\r\n\r\n\t\t\t\tconst newXScale = xScale.copy().domain(domain);\r\n\t\t\t\tconst newWidth = Math.floor(newXScale(xAccessor(last(plotData)))\r\n\t\t\t\t\t- newXScale(xAccessor(head(plotData))));\r\n\r\n\t\t\t\tlog(`and ouch, that is too much, so instead showing ${plotData.length} in ${newWidth}px`);\r\n\t\t\t}\r\n\t\t}\r\n\t\treturn { plotData, domain };\r\n\t}\r\n\treturn { filterData };\r\n}\r\n\r\nfunction canShowTheseManyPeriods(width, arrayLength, maxThreshold, minThreshold) {\r\n\treturn arrayLength > showMinThreshold(width, minThreshold) && arrayLength < showMaxThreshold(width, maxThreshold);\r\n}\r\n\r\nfunction showMinThreshold(width, threshold) {\r\n\treturn Math.max(1, Math.ceil(width * threshold));\r\n}\r\n\r\nfunction showMaxThreshold(width, threshold) {\r\n\treturn Math.floor(width * threshold);\r\n}\r\n\r\nfunction showMax(width, threshold) {\r\n\treturn Math.floor(showMaxThreshold(width, threshold) * 0.97);\r\n}\r\n\r\nfunction getFilteredResponse(data, left, right, xAccessor) {\r\n\tconst newLeftIndex = getClosestItemIndexes(data, left, xAccessor).right;\r\n\tconst newRightIndex = getClosestItemIndexes(data, right, xAccessor).left;\r\n\r\n\tconst filteredData = data.slice(newLeftIndex, newRightIndex + 1);\r\n\t// console.log(right, newRightIndex, dataForInterval.length);\r\n\r\n\treturn filteredData;\r\n}\r\n\r\nexport default function({\r\n\txScale, useWholeData, clamp,\r\n\tpointsPerPxThreshold, minPointsPerPxThreshold,\r\n\tflipXScale\r\n}) {\r\n\treturn extentsWrapper(\r\n\t\tuseWholeData || isNotDefined(xScale.invert),\r\n\t\tclamp,\r\n\t\tpointsPerPxThreshold,\r\n\t\tminPointsPerPxThreshold,\r\n\t\tflipXScale\r\n\t);\r\n}\r\n"],"mappings":";;;;;;;AAEA;;;;;;;;;;;;;;AASA,IAAMA,GAAG,GAAG,IAAAC,gBAAA,EAAU,WAAV,CAAZ;;AAEA,SAASC,SAAT,CAAmBC,WAAnB,EAAgCC,SAAhC,EAA2CC,aAA3C,EAA0DC,KAA1D,EAAiE;EAChE,IACCC,QADD,GAEIJ,WAFJ,CACCI,QADD;EAAA,IACWC,SADX,GAEIL,WAFJ,CACWK,SADX;EAGA,IAAMC,cAAc,GAAGL,SAAS,CAACG,QAAD,CAAhC;;EACA,2BAA+BF,aAAa,CAACK,KAAd,EAA/B;EAAA;EAAA,IAAOC,UAAP;EAAA,IAAmBC,QAAnB;;EAEA,IAAMC,MAAM,GAAG,CAACD,QAAQ,GAAGD,UAAZ,KAA2BH,SAAS,GAAGG,UAAvC,KAAsDF,cAAc,GAAGH,KAAvE,IAAgFA,KAA/F;EACA,OAAOO,MAAP;AACA;;AAED,SAASC,cAAT,CAAwBC,YAAxB,EAAsCC,KAAtC,EAA6CC,oBAA7C,EAAmEC,uBAAnE,EAA4FC,UAA5F,EAAwG;EACvG,SAASC,UAAT,CACCC,IADD,EACOC,WADP,EACoBlB,SADpB,EAC+BC,aAD/B,EAGE;IAAA,+EADgE,EAChE;IAAA,IADCkB,eACD,QADCA,eACD;IAAA,IADkBC,aAClB,QADkBA,aAClB;IAAA,IADiCC,aACjC,QADiCA,aACjC;IAAA,IADgDtB,WAChD,QADgDA,WAChD;;IACD,IAAIY,YAAJ,EAAkB;MACjB,OAAO;QAAEW,QAAQ,EAAEL,IAAZ;QAAkBM,MAAM,EAAEL;MAA1B,CAAP;IACA;;IAED,IAAIM,IAAI,GAAG,IAAAC,WAAA,EAAKP,WAAL,CAAX;IACA,IAAIQ,KAAK,GAAG,IAAAC,WAAA,EAAKT,WAAL,CAAZ;IACA,IAAIU,aAAa,GAAGV,WAApB;IAEA,IAAIW,YAAY,GAAGC,mBAAmB,CAACb,IAAD,EAAOO,IAAP,EAAaE,KAAb,EAAoB1B,SAApB,CAAtC;;IAEA,IAAI6B,YAAY,CAACE,MAAb,KAAwB,CAAxB,IAA6B,IAAAC,gBAAA,EAAUX,aAAV,CAAjC,EAA2D;MAC1DG,IAAI,GAAGH,aAAP;MACAK,KAAK,GAAG5B,SAAS,CAACC,WAAD,EAAcC,SAAd,EAAyBC,aAAzB,EAAwCuB,IAAxC,CAAjB;MAEAI,aAAa,GAAG,CACfJ,IADe,EAEfE,KAFe,CAAhB;MAIAG,YAAY,GAAGC,mBAAmB,CAACb,IAAD,EAAOO,IAAP,EAAaE,KAAb,EAAoB1B,SAApB,CAAlC;IACA;;IAED,IAAI,OAAOY,KAAP,KAAiB,UAArB,EAAiC;MAChCgB,aAAa,GAAGhB,KAAK,CAACgB,aAAD,EAAgB,CAAC5B,SAAS,CAAC,IAAAyB,WAAA,EAAKR,IAAL,CAAD,CAAV,EAAwBjB,SAAS,CAAC,IAAA2B,WAAA,EAAKV,IAAL,CAAD,CAAjC,CAAhB,CAArB;IACA,CAFD,MAEO;MACN,IAAIL,KAAK,KAAK,MAAV,IAAoBA,KAAK,KAAK,MAA9B,IAAwCA,KAAK,KAAK,IAAtD,EAA4D;QAC3DgB,aAAa,GAAG,CACfK,IAAI,CAACC,GAAL,CAASV,IAAT,EAAexB,SAAS,CAAC,IAAAyB,WAAA,EAAKR,IAAL,CAAD,CAAxB,CADe,EAEfW,aAAa,CAAC,CAAD,CAFE,CAAhB;MAIA;;MAED,IAAIhB,KAAK,KAAK,OAAV,IAAqBA,KAAK,KAAK,MAA/B,IAAyCA,KAAK,KAAK,IAAvD,EAA6D;QAC5DgB,aAAa,GAAG,CACfA,aAAa,CAAC,CAAD,CADE,EAEfK,IAAI,CAACE,GAAL,CAAST,KAAT,EAAgB1B,SAAS,CAAC,IAAA2B,WAAA,EAAKV,IAAL,CAAD,CAAzB,CAFe,CAAhB;MAIA;IACD;;IAED,IAAIW,aAAa,KAAKV,WAAtB,EAAmC;MAClCW,YAAY,GAAGC,mBAAmB,CAACb,IAAD,EAAOW,aAAa,CAAC,CAAD,CAApB,EAAyBA,aAAa,CAAC,CAAD,CAAtC,EAA2C5B,SAA3C,CAAlC;IACA;;IAED,IAAMoC,eAAe,GAAGR,aAAxB,CA5CC,CA6CD;;IAEA,IAAMS,MAAM,GAAGpC,aAAa,CAACqC,IAAd,GAAqBf,MAArB,CAA4Ba,eAA5B,CAAf;IAEA,IAAIG,KAAK,GAAGN,IAAI,CAACO,KAAL,CAAWH,MAAM,CAACrC,SAAS,CAAC,IAAA2B,WAAA,EAAKE,YAAL,CAAD,CAAV,CAAN,GACpBQ,MAAM,CAACrC,SAAS,CAAC,IAAAyB,WAAA,EAAKI,YAAL,CAAD,CAAV,CADG,CAAZ,CAjDC,CAoDD;;IACA,IAAId,UAAU,IAAIwB,KAAK,GAAG,CAA1B,EAA6B;MAC5BA,KAAK,GAAGA,KAAK,GAAG,CAAC,CAAjB;IACA;;IAED,IAAIjB,QAAJ,EAAcC,MAAd;IAEA,IAAMkB,UAAU,GAAG,IAAAd,WAAA,EAAKU,MAAM,CAAC/B,KAAP,EAAL,IAAuB,IAAAmB,WAAA,EAAKY,MAAM,CAAC/B,KAAP,EAAL,CAA1C;IAEAV,GAAG,CAAC,yBAAkBiC,YAAY,CAACE,MAA/B,wBAAmDQ,KAAnD,uCACoBG,gBAAgB,CAACH,KAAD,EAAQ1B,oBAAR,CAAhB,GAAgD,CADpE,4EAEqC4B,UAFrC,4CAEiF5B,oBAFjF,CAAD,CAAH;;IAIA,IAAI8B,uBAAuB,CAACJ,KAAD,EAAQV,YAAY,CAACE,MAArB,EAA6BlB,oBAA7B,EAAmDC,uBAAnD,CAA3B,EAAwG;MACvGQ,QAAQ,GAAGO,YAAX;MACAN,MAAM,GAAGa,eAAT;MACAxC,GAAG,CAAC,eAAD,CAAH;IACA,CAJD,MAIO;MACN,IAAI6C,UAAU,GAAGC,gBAAgB,CAACH,KAAD,EAAQ1B,oBAAR,CAA7B,IAA8D,IAAAmB,gBAAA,EAAUjC,WAAV,CAAlE,EAA0F;QACzFuB,QAAQ,GAAGO,YAAX;QACA,IAAMpB,MAAM,GAAGX,SAAS,CAACC,WAAD,EAAcC,SAAd,EAAyBC,aAAzB,EAAwC,IAAAwB,WAAA,EAAKW,eAAL,CAAxC,CAAxB;QACAb,MAAM,GAAG,CACR,IAAAE,WAAA,EAAKW,eAAL,CADQ,EAER3B,MAFQ,CAAT,CAHyF,CAOzF;QACA;;QAEA,IAAMmC,SAAS,GAAGP,MAAM,CAACC,IAAP,GAAcf,MAAd,CAAqBA,MAArB,CAAlB;QACA,IAAMsB,QAAQ,GAAGZ,IAAI,CAACO,KAAL,CAAWI,SAAS,CAAC5C,SAAS,CAAC,IAAA2B,WAAA,EAAKL,QAAL,CAAD,CAAV,CAAT,GACzBsB,SAAS,CAAC5C,SAAS,CAAC,IAAAyB,WAAA,EAAKH,QAAL,CAAD,CAAV,CADK,CAAjB;QAGA1B,GAAG,0DAAmD0B,QAAQ,CAACS,MAA5D,iBAAyEc,QAAzE,QAAH;MACA,CAfD,MAeO;QACNvB,QAAQ,GAAGH,eAAe,IAAIU,YAAY,CAACiB,KAAb,CAAmBjB,YAAY,CAACE,MAAb,GAAsBgB,OAAO,CAACR,KAAD,EAAQ1B,oBAAR,CAAhD,CAA9B;QACAU,MAAM,GAAGH,aAAa,IAAI,CAACpB,SAAS,CAAC,IAAAyB,WAAA,EAAKH,QAAL,CAAD,CAAV,EAA4BtB,SAAS,CAAC,IAAA2B,WAAA,EAAKL,QAAL,CAAD,CAArC,CAA1B;;QAEA,IAAMsB,UAAS,GAAGP,MAAM,CAACC,IAAP,GAAcf,MAAd,CAAqBA,MAArB,CAAlB;;QACA,IAAMsB,SAAQ,GAAGZ,IAAI,CAACO,KAAL,CAAWI,UAAS,CAAC5C,SAAS,CAAC,IAAA2B,WAAA,EAAKL,QAAL,CAAD,CAAV,CAAT,GACzBsB,UAAS,CAAC5C,SAAS,CAAC,IAAAyB,WAAA,EAAKH,QAAL,CAAD,CAAV,CADK,CAAjB;;QAGA1B,GAAG,0DAAmD0B,QAAQ,CAACS,MAA5D,iBAAyEc,SAAzE,QAAH;MACA;IACD;;IACD,OAAO;MAAEvB,QAAQ,EAARA,QAAF;MAAYC,MAAM,EAANA;IAAZ,CAAP;EACA;;EACD,OAAO;IAAEP,UAAU,EAAVA;EAAF,CAAP;AACA;;AAED,SAAS2B,uBAAT,CAAiCJ,KAAjC,EAAwCS,WAAxC,EAAqDC,YAArD,EAAmEC,YAAnE,EAAiF;EAChF,OAAOF,WAAW,GAAGG,gBAAgB,CAACZ,KAAD,EAAQW,YAAR,CAA9B,IAAuDF,WAAW,GAAGN,gBAAgB,CAACH,KAAD,EAAQU,YAAR,CAA5F;AACA;;AAED,SAASE,gBAAT,CAA0BZ,KAA1B,EAAiCa,SAAjC,EAA4C;EAC3C,OAAOnB,IAAI,CAACC,GAAL,CAAS,CAAT,EAAYD,IAAI,CAACoB,IAAL,CAAUd,KAAK,GAAGa,SAAlB,CAAZ,CAAP;AACA;;AAED,SAASV,gBAAT,CAA0BH,KAA1B,EAAiCa,SAAjC,EAA4C;EAC3C,OAAOnB,IAAI,CAACO,KAAL,CAAWD,KAAK,GAAGa,SAAnB,CAAP;AACA;;AAED,SAASL,OAAT,CAAiBR,KAAjB,EAAwBa,SAAxB,EAAmC;EAClC,OAAOnB,IAAI,CAACO,KAAL,CAAWE,gBAAgB,CAACH,KAAD,EAAQa,SAAR,CAAhB,GAAqC,IAAhD,CAAP;AACA;;AAED,SAAStB,mBAAT,CAA6Bb,IAA7B,EAAmCO,IAAnC,EAAyCE,KAAzC,EAAgD1B,SAAhD,EAA2D;EAC1D,IAAMsD,YAAY,GAAG,IAAAC,4BAAA,EAAsBtC,IAAtB,EAA4BO,IAA5B,EAAkCxB,SAAlC,EAA6C0B,KAAlE;EACA,IAAM8B,aAAa,GAAG,IAAAD,4BAAA,EAAsBtC,IAAtB,EAA4BS,KAA5B,EAAmC1B,SAAnC,EAA8CwB,IAApE;EAEA,IAAMK,YAAY,GAAGZ,IAAI,CAAC6B,KAAL,CAAWQ,YAAX,EAAyBE,aAAa,GAAG,CAAzC,CAArB,CAJ0D,CAK1D;;EAEA,OAAO3B,YAAP;AACA;;AAEc,yBAIZ;EAAA,IAHFQ,MAGE,SAHFA,MAGE;EAAA,IAHM1B,YAGN,SAHMA,YAGN;EAAA,IAHoBC,KAGpB,SAHoBA,KAGpB;EAAA,IAFFC,oBAEE,SAFFA,oBAEE;EAAA,IAFoBC,uBAEpB,SAFoBA,uBAEpB;EAAA,IADFC,UACE,SADFA,UACE;EACF,OAAOL,cAAc,CACpBC,YAAY,IAAI,IAAA8C,mBAAA,EAAapB,MAAM,CAACqB,MAApB,CADI,EAEpB9C,KAFoB,EAGpBC,oBAHoB,EAIpBC,uBAJoB,EAKpBC,UALoB,CAArB;AAOA"}