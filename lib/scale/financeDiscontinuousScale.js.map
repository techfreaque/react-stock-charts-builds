{"version":3,"file":"financeDiscontinuousScale.js","names":["MAX_LEVEL","levelDefinition","length","financeDiscontinuousScale","index","futureProvider","backingLinearScale","scaleLinear","isNotDefined","Error","scale","x","invert","inverted","Math","round","domain","arguments","range","rangeRound","clamp","interpolate","ticks","m","flexTicks","backingTicks","ticksMap","map","domainStart","domainEnd","start","max","ceil","head","abs","end","min","floor","last","desiredTickCount","i","ticksAtLevel","get","temp","slice","j","level","push","set","unsortedTicks","concat","d","sort","ascending","ticksSet","distance","remove","tickValues","values","parseInt","tickFormat","format","date","value","isDefined","nice","copy"],"sources":["../../../src/lib/scale/financeDiscontinuousScale.js"],"sourcesContent":["\r\n\r\nimport { set, map } from \"d3-collection\";\r\nimport { ascending } from \"d3-array\";\r\nimport { scaleLinear } from \"d3-scale\";\r\n\r\nimport { isDefined, isNotDefined, head, last } from \"../utils\";\r\nimport { levelDefinition } from \"./levels\";\r\n\r\nconst MAX_LEVEL = levelDefinition.length - 1;\r\n\r\nexport default function financeDiscontinuousScale(\r\n\tindex,\r\n\tfutureProvider,\r\n\tbackingLinearScale = scaleLinear()\r\n) {\r\n\r\n\tif (isNotDefined(index))\r\n\t\tthrow new Error(\"Use the discontinuousTimeScaleProvider to create financeDiscontinuousScale\");\r\n\r\n\tfunction scale(x) {\r\n\t\treturn backingLinearScale(x);\r\n\t}\r\n\tscale.invert = function(x) {\r\n\t\tconst inverted = backingLinearScale.invert(x);\r\n\t\treturn Math.round(inverted * 10000) / 10000;\r\n\t};\r\n\tscale.domain = function(x) {\r\n\t\tif (!arguments.length) return backingLinearScale.domain();\r\n\t\tbackingLinearScale.domain(x);\r\n\t\treturn scale;\r\n\t};\r\n\tscale.range = function(x) {\r\n\t\tif (!arguments.length) return backingLinearScale.range();\r\n\t\tbackingLinearScale.range(x);\r\n\t\treturn scale;\r\n\t};\r\n\tscale.rangeRound = function(x) {\r\n\t\treturn backingLinearScale.range(x);\r\n\t};\r\n\tscale.clamp = function(x) {\r\n\t\tif (!arguments.length) return backingLinearScale.clamp();\r\n\t\tbackingLinearScale.clamp(x);\r\n\t\treturn scale;\r\n\t};\r\n\tscale.interpolate = function(x) {\r\n\t\tif (!arguments.length) return backingLinearScale.interpolate();\r\n\t\tbackingLinearScale.interpolate(x);\r\n\t\treturn scale;\r\n\t};\r\n\tscale.ticks = function(m, flexTicks) {\r\n\t\tconst backingTicks = backingLinearScale.ticks(m);\r\n\t\tconst ticksMap = map();\r\n\r\n\t\tconst [domainStart, domainEnd] = backingLinearScale.domain();\r\n\r\n\t\tconst start = Math.max(Math.ceil(domainStart), head(index).index) + Math.abs(head(index).index);\r\n\t\tconst end = Math.min(Math.floor(domainEnd), last(index).index) + Math.abs(head(index).index);\r\n\r\n\t\tif (Math.floor(domainEnd) > end) {\r\n\t\t\t// console.log(end, domainEnd, index);\r\n\t\t}\r\n\r\n\t\tconst desiredTickCount = Math.ceil((end - start) / (domainEnd - domainStart) * backingTicks.length);\r\n\r\n\t\tfor (let i = MAX_LEVEL; i >= 0; i--) {\r\n\t\t\tconst ticksAtLevel = ticksMap.get(i);\r\n\t\t\tconst temp = isNotDefined(ticksAtLevel)\r\n\t\t\t\t? []\r\n\t\t\t\t: ticksAtLevel.slice();\r\n\r\n\t\t\tfor (let j = start; j <= end; j++) {\r\n\t\t\t\tif (index[j].level === i) {\r\n\t\t\t\t\ttemp.push(index[j]);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\tticksMap.set(i, temp);\r\n\t\t}\r\n\r\n\t\tlet unsortedTicks = [];\r\n\t\tfor (let i = MAX_LEVEL; i >= 0; i--) {\r\n\t\t\tif ((ticksMap.get(i).length + unsortedTicks.length) > desiredTickCount * 1.5) break;\r\n\t\t\tunsortedTicks = unsortedTicks.concat(ticksMap.get(i).map(d => d.index));\r\n\t\t}\r\n\r\n\t\tconst ticks = unsortedTicks.sort(ascending);\r\n\r\n\t\t// console.log(backingTicks.length, desiredTickCount, ticks, ticksMap);\r\n\r\n\t\tif (!flexTicks && end - start > ticks.length) {\r\n\t\t\tconst ticksSet = set(ticks);\r\n\r\n\t\t\tconst d = Math.abs(head(index).index);\r\n\r\n\t\t\t// ignore ticks within this distance\r\n\t\t\tconst distance = Math.ceil(\r\n\t\t\t\t(backingTicks.length > 0\r\n\t\t\t\t\t? (last(backingTicks) - head(backingTicks)) / (backingTicks.length) / 4\r\n\t\t\t\t\t: 1) * 1.5);\r\n\r\n\t\t\tfor (let i = 0; i < ticks.length - 1; i++) {\r\n\t\t\t\tfor (let j = i + 1; j < ticks.length; j++) {\r\n\t\t\t\t\tif (ticks[j] - ticks[i] <= distance) {\r\n\t\t\t\t\t\tticksSet.remove(index[ticks[i] + d].level >= index[ticks[j] + d].level ? ticks[j] : ticks[i]);\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\tconst tickValues = ticksSet.values().map(d => parseInt(d, 10));\r\n\r\n\t\t\t// console.log(ticks.length, tickValues, level);\r\n\t\t\t// console.log(ticks, tickValues, distance);\r\n\r\n\t\t\treturn tickValues;\r\n\t\t}\r\n\r\n\t\treturn ticks;\r\n\t};\r\n\tscale.tickFormat = function() {\r\n\t\treturn function(x) {\r\n\t\t\tconst d = Math.abs(head(index).index);\r\n\t\t\tconst { format, date } = index[Math.floor(x + d)];\r\n\t\t\treturn format(date);\r\n\t\t};\r\n\t};\r\n\tscale.value = function(x) {\r\n\t\tconst d = Math.abs(head(index).index);\r\n\t\tif (isDefined(index[Math.floor(x + d)])) {\r\n\t\t\tconst { date } = index[Math.floor(x + d)];\r\n\t\t\treturn date;\r\n\t\t}\r\n\t};\r\n\tscale.nice = function(m) {\r\n\t\tbackingLinearScale.nice(m);\r\n\t\treturn scale;\r\n\t};\r\n\tscale.index = function(x) {\r\n\t\tif (!arguments.length) return index;\r\n\t\tindex = x;\r\n\t\treturn scale;\r\n\t};\r\n\tscale.copy = function() {\r\n\t\treturn financeDiscontinuousScale(index, futureProvider, backingLinearScale.copy());\r\n\t};\r\n\treturn scale;\r\n}"],"mappings":"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"}